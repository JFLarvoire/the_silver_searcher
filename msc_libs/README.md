# Microsoft Visual C++ compatibility libraries

This folder contains external libraries necessary for building The Silver Searcher for Windows using Microsoft Visual C++.

Usage:

Open a cmd.exe command window; Go to the_silver_searcher root directory; Then run:

    msc_libs\configure.bat
    msc_libs\make.bat

This builds the necessary libraries in msc_libs, then ag.exe.  
The 32 and 64 bits versions of ag.exe will be stored in bin\WIN32\ and bin\WIN64\ respectively.


## Ag.exe features

The ag.exe programs built with these libraries have the following features:

- Support Windows XP and higher versions of Windows. (Windows Server 2003 minimum for the 64-bits version.)
- Support path names up to 64KB. (Using WIN32 APIs not limited to 260 bytes, even in XP.)
- Support Unicode path names.
- Support text files encoded both in UTF-8 and in the current Windows System Code Page.  
  (The latter depends on the Windows localization. Ex: CP 1252 for US and West-European versions of Windows.)
- Support Unicode search strings and regular expressions.  
  (Some limitations for regexps searches in files encoded in Windows system CP, especially for MBCS CPs.)  
- Output non-ASCII characters correctly in any console code page.  
  (Provided that the console font has bitmaps for them. See the table below.)  
  (But if the output is piped to a file or another program, it'll be converted to the current console code page,
  and unsupported characters will be lost. This is a limitation of the Windows console, not of ag.exe.)

Console font          | Character families it can display
--------------------- | ---------------------------------------------------------------------
Arial sans MS         | Latin; Greek; Cyrillic
Liberation Mono       | Latin; Greek; Cyrillic; Hebrew
Microsoft YaHei       | Latin; Greek; Cyrillic; CJK Ideograms; Hiragana; Katakana; Hangul
Yu Gothic             | Latin; Greek; Cyrillic; Dingbats; CJK Ideograms; Hiragana; Katakana


## Visual C++

If needed, the "Visual Studio Community" edition is a free version of Visual C++ for Windows, available at:
https://www.visualstudio.com/vs/cplusplus/

When installing it, select the workload "Desktop Development with C++",
and the options "C++/CLI support" and "Standard Library modules".

The ag build has been tested successfully with Visual Studio versions 2013, 2015, and 2017.  
Older versions of Visual Studio will NOT to work, due to lack of C99 support.  
Note that all libraries build successfully with Visual Studio 2005. So converting ag/src/*.c to be C89-compliant
would allow adding support for older versions of Windows, and even for MS-DOS!


## The configure.bat and make.bat scripts

configure.bat searches the installed versions of Visual C++, Windows SDKs, and the necessary libraries.  
It generates config.HOSTNAME.bat files, with definitions of the paths to the tools and libraries to use.  
This script is automatically run once, the first time you build ag. (Running it manually allows to verify
that all tools and libraries are correctly located, before going on with the build.)  
You need to run it again only if you install new versions of any of the build tools or libraries, or move them to different places.

make.bat is a front-end to nmake.exe.  
It uses the config.HOSTNAME.bat generated by configure.bat to locate all the necessary tools.  
Then it uses the target-version-specific make files in msc_libs\include to build each library and program version.  
A log file with all compiler messages is created every time, and displayed automatically in case of a compilation error.  

Both scripts are actually located in the msc_libs\include sub-directory.  
The short eponymous scripts in msc_libs are just proxies included for your convenience.  
You may want to add the absolute path to msc_libs\include in your PATH. This allows using make.bat in any directory,
for rebuilding one component without rebuilding the rest.  
For example, once the libraries have been built, you may want to run make.bat in the src directory,
to save time when just rebuilding ag.exe.


## MsvcLibX - MSVC Library Extensions

Home page: https://github.com/JFLarvoire/SysToolsLib/tree/master/C/MsvcLibX.

The MsvcLibX library extends Microsoft Visual C++ Standard C Libraries, adding many missing standard Unix definitions and functions.  
It also includes support for UTF-8 command-lines, file names, input and output.  
This ensures that Unix programs designed for use in an UTF-8 environment behave correctly in Windows' UTF16 environment, in any console code page.

MsvcLibX is one component of the System Tools Library, as are the configure and make scripts described above.  

#### Files added
None

#### Files modified
None


## pcre - Perl-Compatible Regular Expressions library

Home page: http://www.pcre.org/

Using pcre 8.40, which is the latest in the PCRE 1 series as of February 2017.  
Do not use pcre2, which has different APIs.

#### Files added
Name               | Description
-------------------|-------------------------------------------------------------------
config.h.MsvcLibX  | Hand-crafted config.h for pcre, describing MsvcLibX capabilities.
configure.pcre.bat | Tells configure.bat to use the MsvcLibX library.
Files.mak          | Define input and output files.
pcre.mak           | Pcre-specific make rules.

#### Files modified
None


## pthreads - Posix Threads for Windows library

Home page: http://sourceforge.net/projects/pthreads4w/

Using the same pthread 2.10 beta used by [KJK](https://github.com/kjk/the_silver_searcher).  
I tried using the latest 2.10 RC, but it hangs at run time.
So I reverted to KJK's version, which works fine, until I find the root cause for the hangs in the newer version.

#### Files added
Name                  | Description
----------------------|--------------------------------------------------------------------------------
configure.pthread.bat | Tells configure.bat to ignore Nmakefile, and NOT to use the MsvcLibX library.
Files.mak             | Define input and output files.
pthread.mak           | Pthread-specific make rules.

#### Files modified
Name        | Description
------------|----------------------------------------------------------------------------------------------------------
implement.h | Line 123: Changed '#if defined(PTW32_CONFIG_MINGW)' to '#if defined(PTW32_CONFIG_MINGW) || defined(HAS_MSVCLIBX)', to force including MsvcLibX's stdint.h.
sched.h     | Line 132: Changed pid_t definition for MSC to int.

Gotcha: pthread has its own Nmakefile file, which we do not want to use.  
Hence the special IGNORE_NMAKEFILE definition in configure.pthread.bat.


## zLib - File compression library

Home page: http://www.zlib.net/

Using zlib 1.2.11, which is the latest version as of February 2017.

#### Files added
Name               | Description
-------------------|-------------------------------------------------------------------
configure.zlib.bat | Tells configure.bat to use the MsvcLibX library.
Files.mak          | Define input and output files.
zlib.mak           | Zlib-specific make rules.

#### Files modified
None


## Debug versions

Setting the DEBUG environment variable before running make.bat allows to build the debug versions of the libraries and ag.exe programs.

    set "DEBUG=1"
    make

The debug versions of the program are output in bin\WIN32\Debug\ and bin\WIN64\Debug\ respectively.

Recommended: The debug versions of the pcre and zlib libraries output huge amounts of data, which is rarely interesting for ag.exe debugging.  
After building the debug libraries for the first time, overwrite the debug versions of the pcre and zlib libraries with the non-debug ones.
Then relink ag.exe using these libraries:

    :# Overwrite the debug libraries
    copy /y msc_libs\pcre\bin\WIN32\pcre.lib msc_libs\pcre\bin\WIN32\Debug\pcre.lib
    copy /y msc_libs\pcre\bin\WIN64\pcre.lib msc_libs\pcre\bin\WIN64\Debug\pcre.lib
    copy /y msc_libs\zlib\bin\WIN32\zlib.lib msc_libs\zlib\bin\WIN32\Debug\zlib.lib
    copy /y msc_libs\zlib\bin\WIN64\zlib.lib msc_libs\zlib\bin\WIN64\Debug\zlib.lib
    :# Delete the old debug versions of ag.exe
    del bin\WIN32\Debug\ag.exe
    del bin\WIN64\Debug\ag.exe
    :# Descend into the src directory, to avoid relinking the debug libraries we just copied
    cd src
    :# Rebuild only ag.exe
    ..\msc_libs\make.bat
