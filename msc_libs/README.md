# Microsoft Visual C++ compatibility libraries

This folder contains external libraries necessary for building The Silver Searcher with Microsoft Visual C++.

Usage:

Open a command window; Go to the_silver_searcher root directory; Then run:

    msc_libs\configure.bat
    msc_libs\make.bat

This builds the necessary libraries in msc_libs, then ag.exe.  
The 32 and 64 bits versions of ag.exe will be stored in src\bin\WIN32 and src\bin\WIN64 respectively.


## Visual C++

If needed, the "Visual Studio Community" edition is a free version of Visual C++ for Windows, available at:
https://www.visualstudio.com/vs/cplusplus/

When installing it, select the workload "Desktop Development with C++",
and the options "C++/CLI support" and "Standard Library modules".

The ag build has been tested successfully with Visual Studio versions  2013 and 2015.  
The pre-release versions of visual Studio 2017 are not detected by configure.bat. It's likely to work once configure.bat is updated.  
Older versions of Visual Studio will NOT to work, due to lack of C99 support.  
Note that all libraries build successfully with Visual Studio 2005. So converting ag/src/*.c to be C89-compliant would be really useful.


## The configure.bat and make.bat scripts

configure.bat searches the installed versions of Visual C++, Windows SDKs, and the necessary libraries.  
It generates config.HOSTNAME.bat files, with definitions of the paths to the tools and libraries to use.  
This script is automatically run once, the first time you build ag. (Running it manually allows to verify that all tools and libraries are correctly located, before going on with the build.)  
You need to run it again only if you install new versions of any of the build tools or libraries, or move them to different places.

make.bat is a front-end to nmake.exe.  
It uses the config.HOSTNAME.bat generated by configure.bat to locate all the necessary tools.  
Then it uses the target-version-specific make files in msc_libs\include to build each library and program version.  
A log file with all compiler messages is created every time, and displayed automatically in case of a compilation error.  

Both scripts are actually located in the msc_libs\include sub-directory.  
The short eponymous scripts in msc_libs are just proxies included for your convenience.  
You may want to add the absolute path to msc_libs\include in your PATH. This allows using make.bat in any directory, for rebuilding one component without rebuilding the rest.  
For example, once the libraries have been built, you may want to run make.bat in the src directory, to save time when just rebuilding ag.exe.


## MsvcLibX - MSVC Library Extensions

Home page: https://github.com/JFLarvoire/SysToolsLib/tree/master/C/MsvcLibX.

The MsvcLibX library extends Microsoft Visual C++ Standard C Libraries, adding many missing standard Unix definitions and functions.  
It also includes support for UTF-8 command-lines, file names, input and output.  
This ensures that Unix programs designed for use in an UTF-8 environment behave correctly in Windows' UTF16 environment, in any console code page.

MsvcLibX is one component of the System Tools Library, as are the configure and make scripts described above.  
Note that I've removed several make files from ag's msc_libs\include, targeting OS/processor combinations not supported by ag now. Ex: MS-DOS, which does not support mmap() nor pthreads.  
If you want to try building ag.exe for one of the cases that might make sense (Ex: IA64 or ARM versions of Windows), you may copy the corresponding make files from https://github.com/JFLarvoire/SysToolsLib/tree/master/C/include.

#### Files added
None

#### Files modified
None


## pcre - Perl-Compatible Regular Expressions library

Home page: http://www.pcre.org/

Using pcre 8.40, which is the latest in the PCRE 1 series as of February 2017.  
Do not use pcre2, which has different APIs.

#### Files added
Name               | Description
-------------------|-------------------------------------------------------------------
config.h.MsvcLibX  | Hand-crafted config.h for pcre, describing MsvcLibX capabilities.
configure.pcre.bat | Tells configure.bat to use the MsvcLibX library.
Files.mak          | Define input and output files.
pcre.mak           | Pcre-specific make rules.

#### Files modified
None


## pthreads - Posix Threads for Windows library

Home page: http://sourceforge.net/projects/pthreads4w/

Using the same pthread 2.10 beta used by [KJK](https://github.com/kjk/the_silver_searcher).  
I tried using the latest 2.10 RC, but it hangs at run time.
So I reverted to KJK's version, which works fine, until I find the root cause for the hangs in the newer version.

#### Files added
Name                  | Description
----------------------|--------------------------------------------------------------------------------
configure.pthread.bat | Tells configure.bat to ignore Nmakefile, and NOT to use the MsvcLibX library.
Files.mak             | Define input and output files.
pthread.mak           | Pthread-specific make rules.

#### Files modified
Name        | Description
------------|----------------------------------------------------------------------------------------------------------
implement.h | Line 123: Changed '#if defined(PTW32_CONFIG_MINGW)' to '#if defined(PTW32_CONFIG_MINGW) || defined(HAS_MSVCLIBX)', to force including MsvcLibX's stdint.h.
sched.h     | Line 132: Changed pid_t definition for MSC to int.

Gotcha: pthread has its own Nmakefile file, which we do not want to use.  
Hence the special IGNORE_NMAKEFILE definition in configure.pthread.bat.


## zLib - File compression library

Home page: http://www.zlib.net/

Using zlib 1.2.11, which is the latest version as of February 2017.

#### Files added
Name               | Description
-------------------|-------------------------------------------------------------------
configure.zlib.bat | Tells configure.bat to use the MsvcLibX library.
Files.mak          | Define input and output files.
zlib.mak           | Zlib-specific make rules.

#### Files modified
None

